<!DOCTYPE html>
<meta charset = "UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<head>
	<title>Rays</title>
	
	<script type = "text/javascript" src = "js/lib/es6-promise.auto.min.js"></script>
	<script type = "text/javascript" src = "js/lib/tinycolor2.js"></script>
	<script type = "text/javascript" src = "js/lib/pixi.min.js"></script>
	<script type = "text/javascript" src = "js/rays.js"></script>
	<script type = "text/javascript" src = "js/load.js"></script>
	
	<link rel = "stylesheet" type = "text/css" href = "css/normalize.css">
	<link rel = "stylesheet" type = "text/css" href = "css/rays.css">
	
	<script id = "shader" type = "shader">
		varying vec2 vTextureCoord;
		uniform sampler2D uSampler;
		uniform sampler2D wood_tex;
		uniform sampler2D dark_wood_tex;
		uniform float wood_ratio;
		uniform float tile_width;
		uniform float time;
		
		void main(void){
			// get square color
			float sq_size = tile_width;
			vec2 raw = vec2((vTextureCoord.x / sq_size), (vTextureCoord.y / sq_size));
			vec2 fr = fract(raw);
			vec2 sq_coord = vec2(floor(vTextureCoord.x / sq_size) * sq_size, floor(vTextureCoord.y / sq_size) * sq_size);
			vec4 sq_color = texture2D(uSampler, sq_coord);
			
			// black borders
			float multx = step(abs(fr[0]), 0.8);
			float multy = step(abs(fr[1]), 0.8);
			float border = multx * multy;
			
			// cut out corners -- not working right
			//float corners = (abs(fr[0]) + abs(fr[1])) / 2.0;
			//corners = step(corners, 0.6);
			//border = border * corners;
			
			// step colors
			float num_colors = 6.0;
			sq_color = floor(sq_color * num_colors) / num_colors;
			
			vec4 wood_color = texture2D(wood_tex, vTextureCoord * wood_ratio);
			//wood_color = wood_color * sq_color;
			wood_color = wood_color * step(0.1, sq_color.r);
			
			vec4 dark_wood_color = texture2D(dark_wood_tex, vTextureCoord * wood_ratio);
			
			
			vec4 out_color;
			if (wood_color.r < 0.1) {
				out_color = dark_wood_color;
			}
			else {
				out_color = wood_color;
			}
			
			//gl_FragColor = texture2D(uSampler, vTextureCoord);
			//gl_FragColor = vec4(sq_color.r * multx * multy, sq_color.g * multx * multy, sq_color.b * multx * multy, 1.0);
			gl_FragColor = vec4(out_color.r * border, out_color.g * border, out_color.b * border, 1.0);
		}
	</script>
	
</head>

<html>
<body onload = "rays_app.run()">
	<header class = "page-head">
		<h2>Ray Casting</h2>
	</header>
	<div class = "wrapper">
		<header>
			<h3>FPS: <span id = "fps_field"></span></h3>
			<div id = "rays_controls_container"></div>
			<!--
			<button id = "solid_mode_button">Solid</button>
			<button id = "textured_mode_button">Textured</button>
			<button id = "edge_mode_button">Edges</button>
			-->
		</header>
		
		<div class = "canvas-container">
			<canvas id = "main_canvas" class = "" width = "512px" height = "512px"></canvas>
			<div class = "map-container">
				<canvas id = "map_bg_canvas" class = "map-canvas bg" width = "600px" height = "600px"></canvas
				><canvas id = "map_canvas" class = "map-canvas fg" width = "600px" height = "600px"></canvas>
			</div>
		</div>
		
	</div>
</body>
</html>